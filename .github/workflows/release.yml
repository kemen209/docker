name: Build and push docker

on:
  push:
    branches:
      - 'main'
    tags:
     - 'v**'
jobs:
  docker:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [14.x]
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Get branch names
        id: branch-name
        uses: tj-actions/branch-names@v5.2
        with: 
          strip_tag_prefix: v

      - name: Current branch name
        run: |
          echo "${{ steps.branch-name.outputs.current_branch }}"

      - name: Get the current tag
        if: steps.branch-name.outputs.is_tag == 'true'  # Replaces: startsWith(github.ref, 'refs/tags/')
        run: |
          echo "${{ steps.branch-name.outputs.tag }}"
      
      # - uses: web3j/slice-action@v1.3
      #   if: steps.branch-name.outputs.is_tag == 'true'
      #   id: tag-name
      #   with:
      #     value: ${{steps.branch-name.outputs.tag}}
      #     start: '1'
      #     end: '4'

      # - uses: docker/setup-qemu-action@v1
      # - uses: docker/setup-buildx-action@v1
      #   with:
      #     driver-opts: network=host
      # - uses: docker/login-action@v1
      #   name: Login Docker Hub
      #   with:
      #     username: ${{ secrets.DOCKER_USERNAME }}
      #     password: ${{ secrets.DOCKER_PASSWORD }}
      # - name: Prepare docker image tags
      #   id: docker_meta
      #   uses: crazy-max/ghaction-docker-meta@v1
      #   with:
      #     images: steedos/steedos-project-template
      #     tag-custom: 1.x-next
      #     tag-custom-only: ${{ github.ref == 'refs/heads/1.x' }}
      #     tag-semver: |
      #       {{version}}
      #       {{major}}
      #       {{major}}.{{minor}}
      
      # - name: Delete the latest tag 
      #   uses: mad9000/actions-find-and-replace-string@2
      #   id: tags_result
      #   with:
      #     source: ${{ steps.docker_meta.outputs.tags }} # this translates to ref/heads/main on the main branch, but can be any arbitrary string 
      #     find: 'steedos/steedos-project-template:latest'        # we want to remove ref/heads/ from source 
      #     replace: ''

      # - name: Build & Push 2.1
      #   uses: docker/build-push-action@v2
      #   if: steps.tag-name.outputs.result == '2.1'
      #   with:
      #     context: .
      #     file: ./Dockerfile
      #     platforms: linux/amd64
      #     push: ${{ github.event_name != 'pull_request' }}
      #     tags: ${{ steps.docker_meta.outputs.tags }}
      #     labels: ${{ steps.docker_meta.outputs.labels }}
      
      # - name: Build & Push other
      #   uses: docker/build-push-action@v2
      #   if: steps.tag-name.outputs.result != '2.1'
      #   with:
      #     context: .
      #     file: ./Dockerfile
      #     platforms: linux/amd64
      #     push: ${{ github.event_name != 'pull_request' }}
      #     tags: ${{ steps.tags_result.outputs.value }}
      #     labels: ${{ steps.docker_meta.outputs.labels }}
        